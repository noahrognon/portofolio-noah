---
import { getCarouselItems } from "../fonction/backend.js";

const fetchedItems = await getCarouselItems();
const technologies = fetchedItems
	.filter((item) => item.name && item.icon)
	.map((item) => ({
		id: item.id,
		name: item.name,
		icon: item.icon,
	}));
---

{technologies.length > 0 && (
	<>
		<div class="relative w-full overflow-hidden" data-carousel>
			<div
				class="pointer-events-none absolute inset-y-0 left-0 z-10 hidden w-24 bg-gradient-to-r from-[#0c1014] to-transparent sm:block"
				aria-hidden="true"
			/>
			<div
				class="pointer-events-none absolute inset-y-0 right-0 z-10 hidden w-24 bg-gradient-to-l from-[#0c1014] to-transparent sm:block"
				aria-hidden="true"
			/>

			<div
				class="flex items-center gap-8 px-2 py-2 transition-transform duration-500 will-change-transform sm:px-4"
				data-carousel-track
			>
				<ul class="flex items-center gap-4" data-carousel-strip>
					{technologies.map((tech) => (
						<li class="list-none flex-shrink-0" data-carousel-item>
							<span class="inline-flex h-10 items-center gap-2 rounded-full border border-[#ff7a00]/40 bg-[#10171f] px-4 text-xs font-medium tracking-wide text-slate-100 transition duration-300 hover:-translate-y-0.5 hover:border-[#ff7a00] sm:px-5 sm:text-sm">
								<img src={tech.icon} alt="" class="h-5 w-5 flex-shrink-0" aria-hidden="true" />
								<span class="whitespace-nowrap leading-none">{tech.name}</span>
							</span>
						</li>
					))}
				</ul>
			</div>
		</div>

		<script is:inline>
			if (document.querySelector("[data-carousel]")) {
				const motionQuery = window.matchMedia
					? window.matchMedia("(prefers-reduced-motion: reduce)")
					: { matches: false, addEventListener: null, removeEventListener: null };

				const initCarousel = (root) => {
					const track = root.querySelector("[data-carousel-track]");
					const strip = root.querySelector("[data-carousel-strip]");

					if (!track || !strip || !strip.children.length) {
						return;
					}

					const stripClone = strip.cloneNode(true);
					stripClone.setAttribute("aria-hidden", "true");
					track.appendChild(stripClone);

					let animationFrame;
					let translateX = 0;
					let lastTime = performance.now();
					const baseSpeed = 55;

					const update = (time) => {
						const elapsed = (time - lastTime) / 1000;
						lastTime = time;
						translateX -= baseSpeed * elapsed;

						const firstStrip = track.firstElementChild;
						const styles = getComputedStyle(track);
						const gap = parseFloat(styles.columnGap || styles.gap || "0");
						const firstWidth = firstStrip ? firstStrip.getBoundingClientRect().width : 0;
						const resetThreshold = -(firstWidth + gap);

						if (translateX <= resetThreshold && firstStrip) {
							translateX += firstWidth + gap;
							track.appendChild(firstStrip);
						}

						track.style.transform = `translateX(${translateX}px)`;
						animationFrame = requestAnimationFrame(update);
					};

					const start = () => {
						cancelAnimationFrame(animationFrame);
						lastTime = performance.now();
						animationFrame = requestAnimationFrame(update);
					};

					const stop = () => {
						cancelAnimationFrame(animationFrame);
						animationFrame = undefined;
					};

					if (!motionQuery.matches) {
						start();
					}

					const handleMotionChange = (event) => {
						if (event.matches) {
							stop();
							track.style.transform = "";
						} else {
							start();
						}
					};

					if (typeof motionQuery.addEventListener === "function") {
						motionQuery.addEventListener("change", handleMotionChange);
					} else if (typeof motionQuery.addListener === "function") {
						motionQuery.addListener(handleMotionChange);
					}

					window.addEventListener("resize", () => {
						if (animationFrame) {
							lastTime = performance.now();
						}
					});
				};

				document
					.querySelectorAll("[data-carousel]")
					.forEach((carousel) => initCarousel(carousel));
			}
		</script>
	</>
)}
