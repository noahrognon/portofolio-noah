---
import { getCompetencesDetaillees } from "../fonction/backend.js";
import frontendIcon from "../assets/icons/frontenddevelopement.svg";
import backendIcon from "../assets/icons/backend.svg";
import performanceIcon from "../assets/icons/performance.svg";
import toolsIcon from "../assets/icons/outil.svg";

const domainMeta = {
	frontend: {
		icon: frontendIcon,
		title: "Frontend Development",
	},
	backend: {
		icon: backendIcon,
		title: "Backend & API",
	},
	performance: {
		icon: performanceIcon,
		title: "Performance & SEO",
	},
	outil: {
		icon: toolsIcon,
		title: "Outils & Gestion",
	},
};

const normalizeDomain = (value) =>
	value ? value.toString().trim().toLowerCase() : "";

const normalizeLevel = (value) =>
	value
		? value
				.toString()
				.normalize("NFD")
				.replace(/[\u0300-\u036f]/g, "")
				.toLowerCase()
		: "";

const levelStyles = {
	avance: "text-[#ffb26b] bg-[#ff7a00]/15 ring-1 ring-inset ring-[#ff7a00]/40",
	debutant:
		"text-[#72a9ff] bg-[#1f2c46]/40 ring-1 ring-inset ring-[#3b5f92]/50",
	intermediaire:
		"text-[#ffd16b] bg-[#ffb347]/15 ring-1 ring-inset ring-[#ffb347]/40",
};

const levelClassFor = (levelKey) =>
	levelStyles[levelKey] ??
	"bg-slate-700/30 text-slate-200 ring-1 ring-inset ring-white/5";

const competences = await getCompetencesDetaillees();

const grouped = competences.reduce((acc, competence) => {
	const domainKey = normalizeDomain(competence.domain);
	if (!domainKey) {
		return acc;
	}

	if (!acc[domainKey]) {
		acc[domainKey] = [];
	}

	acc[domainKey].push({
		...competence,
		levelKey: normalizeLevel(competence.level),
	});

	return acc;
}, {});

const sections = Object.entries(domainMeta).map(([domainKey, meta]) => ({
	domainKey,
	...meta,
	skills: grouped[domainKey] ?? [],
}));
---

<section class="w-full mx-auto max-w-7xl px-4 sm:px-6">
	<div class="grid gap-6 md:grid-cols-2">
		{sections.map((section) => (
			<article class="group relative flex flex-col gap-6 rounded-3xl border border-white/5 bg-[#0f1419]/90 px-6 py-7 shadow-[0_20px_50px_-30px_rgba(0,0,0,0.8)] ring-1 ring-black/20 transition-all duration-300 hover:border-[#ff7a00]/40 hover:shadow-[0_30px_60px_-28px_rgba(255,122,0,0.5)] md:px-7 md:py-8">
				<header class="flex items-center gap-4">
					<span class="flex h-12 w-12 items-center justify-center rounded-2xl bg-[#151b22] ring-1 ring-inset ring-white/5 transition duration-300 group-hover:bg-[#1b232d] group-hover:ring-[#ff7a00]/40">
						<img src={section.icon.src} alt="" class="h-7 w-7" aria-hidden="true" />
					</span>
					<h3 class="text-lg font-semibold text-slate-100 md:text-xl">
						{section.title}
					</h3>
				</header>

				<ul class="flex flex-col gap-4">
					{section.skills.length > 0 ? (
						section.skills.map((skill) => (
							<li class="flex items-start justify-between gap-6 rounded-2xl border border-transparent bg-black/0 px-3 py-2 transition duration-200 hover:border-[#ff7a00]/20 hover:bg-[#171f28]">
								<div class="space-y-1">
									<p class="text-sm font-semibold text-slate-100 md:text-base">
										{skill.name || "Sans titre"}
									</p>
									{skill.description && (
										<p class="text-xs text-slate-400 md:text-sm">
											{skill.description}
										</p>
									)}
								</div>
								{skill.level && (
									<span
										class={`ml-auto inline-flex h-7 shrink-0 items-center rounded-full px-3 text-xs font-semibold uppercase tracking-wide ${levelClassFor(skill.levelKey)}`}
									>
										{skill.level}
									</span>
								)}
							</li>
						))
					) : (
						<li class="rounded-2xl border border-dashed border-white/5 bg-black/0 px-3 py-6 text-sm text-slate-500">
							Comp&eacute;tences &agrave; venir.
						</li>
					)}
				</ul>

				<div class="pointer-events-none absolute inset-x-6 top-0 h-px bg-gradient-to-r from-transparent via-white/15 to-transparent opacity-0 transition-opacity duration-300 group-hover:opacity-100 md:inset-x-8" />
			</article>
		))}
	</div>
</section>
